# Nome do fluxo de trabalho.
name: Deploy Estático para AWS S3

# Define o gatilho para o fluxo de trabalho.
on:
  push:
    # Este fluxo será executado sempre que houver um push para o branch 'main'.
    branches:
      - main
    # Configurações de caminhos para ignorar o deploy se APENAS arquivos de documentação
    # forem modificados.
    paths-ignore:
      - 'README.md'
      - '*.txt'
      - '*.xml'
      - '.gitignore'
      - '.vscode/**'
      
  # Permite que você execute o fluxo de trabalho manualmente através da interface do GitHub.
  workflow_dispatch:

# Define as variáveis de ambiente padrão para os jobs.
env:
  AWS_REGION: ${{ secrets.AWS_REGION }} 
  S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}
  
jobs:
  # Define um único trabalho chamado 'deploy'
  deploy:
    runs-on: ubuntu-latest
    
    # Adiciona um output para a lista de arquivos alterados que será usada na invalidação.
    outputs:
      changed_files: ${{ steps.get_changed_files.outputs.all_modified_files }}
      
    steps:
      # 1. Checkout do código (para ter acesso ao histórico de commits)
      - name: Checkout do Repositório
        uses: actions/checkout@v4
        with:
          # Necessário para comparar o commit anterior
          fetch-depth: 0 

      # 2. Obter lista de arquivos alterados (NOVO PASSO CHAVE)
      - name: Obter Arquivos Alterados
        id: get_changed_files
        uses: tj-actions/changed-files@v44
        with:
          # Define o output como a lista de todos os arquivos modificados (adicionados, alterados)
          files_ignore: |
            README.md
            .vscode/**
            *.txt
            *.xml
            .gitignore
          # O output 'modified_files' já é um JSON array, vamos usá-lo.
          json: true
          
      # 3. Configuração das Credenciais AWS
      - name: Configurar Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 4. Sincronização e Deploy para o S3 (Mantido o SYNC para segurança e exclusão)
      # Nota: O S3 Sync é inteligente e SÓ fará upload de arquivos modificados ou novos.
      - name: Deploy Seletivo para AWS S3 (SYNC)
        run: |
          echo "Sincronizando arquivos para s3://${{ env.S3_BUCKET_NAME }}"
          aws s3 sync . s3://${{ env.S3_BUCKET_NAME }} \
            --delete \
            --exclude ".git/*" \
            --exclude ".github/*"
          echo "Deploy para S3 concluído com sucesso. (Apenas arquivos modificados foram realmente enviados)"
          
      # 5. Invalidação Seletiva do CloudFront
      # Condição de execução: SUCESSO na etapa anterior, ID da distribuição presente E arquivos modificados.
      - name: Invalidação Seletiva do CloudFront
        if: success() && env.CLOUDFRONT_DISTRIBUTION_ID != '' && steps.get_changed_files.outputs.modified_files != '[]'
        env:
          MODIFIED_FILES_JSON: ${{ steps.get_changed_files.outputs.modified_files }}
        run: |
          # O tj-actions/changed-files retorna um array JSON, e precisamos transformá-lo em uma string de caminhos.
          # 1. Usa jq para iterar sobre o array, prefixar cada item com '/' (caminho absoluto do CloudFront) e unir com espaços.
          #    O `jq` garante a formatação correta do JSON array para o shell.
          MODIFIED_PATHS=$(echo "${{ env.MODIFIED_FILES_JSON }}" | jq -r '.[] | "/" + .')
          
          # 2. Converte a saída multi-linha do jq em uma única string separada por espaços (necessário para a CLI)
          MODIFIED_PATHS_STRING=$(echo "$MODIFIED_PATHS" | tr '\n' ' ')

          if [ -z "$MODIFIED_PATHS_STRING" ]; then
            echo "Nenhum arquivo de conteúdo alterado. Invalidação de cache ignorada."
          else
            echo "Arquivos a serem invalidados: $MODIFIED_PATHS_STRING"
            
            # 3. Realiza a invalidação de cache APENAS para os caminhos alterados.
            aws cloudfront create-invalidation \
              --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths $MODIFIED_PATHS_STRING
              
            echo "Invalidação Seletiva do CloudFront solicitada para os caminhos listados."
          fi

      # 6. Feedback de Sucesso
      - name: Notificar Sucesso
        run: echo "O Deploy e a Invalidação de Cache (se aplicável) foram concluídos."